#* 
 Copyright 2011 - 88 Creative Pty Ltd. 
 * Copyright of this program is the property of 88 Creative, 
 * without whose written permission reproduction in
 * whole or in part is prohibited. All rights reserved.
 * http://www.inform8.com
 * http://www.88creative.com.au
*#<script language="javascript">	
	var <?php echo $jsToolbarLoaded ?> = false;
	jQuery("#<?php echo $currfkGridId; ?>").jqGrid({ 
    #if($fk.otherConnectingTableField().settings.hasLabel('embeddedjoin') || $fk.otherConnectingTableField().settings.hasLabel('embeddedlinkorjoin'))
			url:'jsongridrest.php?object=${theTable.name}&field=${theField.name}&value=<?php echo $obj->get${table.primaryKey.name}(); ?>&joinTable=${fk.childTable.name}&joinField=${fk.otherField}&otherJoinField=${fk.otherConnectingTableField().name}',
		#else
			url:'jsongridrest.php?object=${theTable.name}&field=${theField.name}&value=<?php echo $obj->get${table.primaryKey.name}(); ?>',
		#end
    datatype: "json", 
    colNames:[
    '<?php echo WebContext::getLanguage()->get('actions'); ?>',
		'<?php echo WebContext::getLanguage()->get('Tbl_${theTable.name}_${theTable.primaryKey.name}'); ?>'
    #foreach( $col in ${theTable.columns} )	#if(!${col.settings.hasLabel('hidden')}) ,'<?php echo WebContext::getLanguage()->get('Tbl_${theTable.name}_${col.name}'); ?>' #end #end	
    ], 
    colModel:[ 
    	{name:'EditButtons', width:50},
		{name:'id', index:'${theTable.primaryKey.name}', width:50, key:true}
    	#foreach( $col in ${theTable.columns} )	
    		#if(!${col.settings.hasLabel('hidden')})
    			,{name:'${col.name}', width:100 #if($col.masterForeignKey),formatter:formatTableLink #else ,formatter:formatCell #end }
    		#end 
    	#end	
    ],
    rowNum:10,
    width:850,
    ondblClickRow: function(id){ newTab('ajax.php?action=Update&object=${theTable.name}&id='+id, '<?php echo WebContext::getLanguage()->get('Tbl_${theTable.name}'); ?> ' + id );},
    rowList:[10,20,50, 100, 200, 500], 
    pager: '#<?php echo $currfkGridPagerId; ?>', 
    sortname: '${theTable.primaryKey.name}',
    #if(!${table.settings.hasLabel('UI_READ_ONLY')} && !${table.settings.hasLabel('DB_READ_ONLY')})multiselect: true,#end 
    viewrecords: true, 
    sortorder: "asc",
	toolbar: [true,"top"],
	loadComplete: function(xhr) { 
		
		window.I8.grids.<?php echo $currfkGridId; ?> = new Object();
		window.I8.grids.<?php echo $currfkGridId; ?>.rows = new Object();

		//console.log(xhr);
		//console.log(xhr.responseText);

		if (xhr != null && xhr.responseText != null &&
		  xhr.responseText != '') {
			var daRows = ${ds}.parseJSON(xhr.responseText).rows;
			var pkIdx = window.I8.td.${theTable.name}.primaryKey.name;
	
			for(idx in daRows) {
				var r = daRows[idx];
				window.I8.grids.<?php echo $currfkGridId ?>.rows[r[pkIdx]] = new Object();
				for (cidx in r.cell) {
					if (cidx != 0) {
						var memAndVal = ${ds}.parseJSON(r.cell[cidx]);
						if (typeof(memAndVal) == 'object') {
						if ('lval' in memAndVal) {
							window.I8.grids.<?php echo $currfkGridId ?>.rows[r[pkIdx]][memAndVal.mem] = memAndVal.lval;
						}else {
							window.I8.grids.<?php echo $currfkGridId ?>.rows[r[pkIdx]][memAndVal.mem] = memAndVal.val;
						}
						}
					}
				}
			}
	
	
			#if(!${table.settings.hasLabel('UI_READ_ONLY')} && !${table.settings.hasLabel('DB_READ_ONLY')})
			var ids = $("#<?php echo $currfkGridId ?>").jqGrid('getDataIDs'); 
			for(var i=0;i < ids.length;i++){ 
				var cl = ids[i]; 
				quickEdit = " <a href='#' title='Quick Edit' onclick=\"buildQuickEditPanel('<?php echo $currfkGridId ?>', '"+cl+"', window.I8.td.${theTable.name}, '#<?php echo $currfkQuickEditId ?>' );return false;\" ><img src='images/smtb/edit.jpg' /></a>"; 
				fullEdit = " <a href='#' title='View/Edit in a new tab' onclick=\"newTab('ajax.php?action=Update&object=${theTable.name}&id="+cl+"', '<?php echo WebContext::getLanguage()->get('Tbl_${theTable.name}'); ?> ' + "+cl+" );return false;\" ><img src='images/smtb/advedit.jpg' /></a>";

			    #if (${theTable.settings.hasLabel('noquickedit')} || ${table.settings.hasLabel('UI_READ_ONLY')} || ${table.settings.hasLabel('DB_READ_ONLY')})
			    	$("#<?php echo $currfkGridId ?>").jqGrid('setRowData',ids[i],{EditButtons:fullEdit});
			    #else
			          $("#<?php echo $currfkGridId ?>").jqGrid('setRowData',ids[i],{EditButtons:quickEdit+fullEdit});
			    #end				
			}
			#end
		}

		if(!<?php echo $jsToolbarLoaded ?>) {
			var shtml = $("#<?php echo $currfkGridTempToolbarId ?>").html();
			$("#t_<?php echo $currfkGridId; ?>").css('height', '100').html(shtml);
			$("#<?php echo $currfkGridTempToolbarId ?>").html('');
			<?php echo $jsToolbarLoaded ?> = true;
		}
						
	},
    caption:"<?php echo WebContext::getLanguage()->get('Tbl_${theTable.name}'); ?>" 
	});
	
	$(window).bind('resize', function() {
  	$("#<?php echo $currfkGridId; ?>").setGridWidth($(window).width()-50);
  }).trigger('resize');	
	
</script>